# yaml-language-server: $schema=https://json.schemastore.org/github-workflow.json

name: Android Release Build

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  build:
    name: Build Android App Bundle
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Java (for keytool)
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "17"

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "stable"

      - name: Install dependencies
        working-directory: mobile
        run: |
          flutter pub get

      - name: Restore keystore from secret
        if: secrets.KEYSTORE_BASE64 != ''
        run: |
          echo "$KEYSTORE_BASE64" | base64 --decode > mobile/android/app/oblns-release-key.jks
        env:
          KEYSTORE_BASE64: ${{ secrets.KEYSTORE_BASE64 }}

      - name: Write key.properties
        if: secrets.KEYSTORE_BASE64 != ''
        env:
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
        run: |
          cat > mobile/android/key.properties <<EOF
          storePassword=$KEYSTORE_PASSWORD
          keyPassword=$KEY_PASSWORD
          keyAlias=$KEY_ALIAS
          storeFile=android/app/oblns-release-key.jks
          EOF

      - name: "Optional: Restore google-services.json"
        if: secrets.GOOGLE_SERVICES_JSON != ''
        env:
          GOOGLE_SERVICES_JSON: ${{ secrets.GOOGLE_SERVICES_JSON }}
        run: |
          echo "$GOOGLE_SERVICES_JSON" | base64 --decode > mobile/android/app/google-services.json

      - name: Build AAB
        working-directory: mobile
        run: |
          flutter build appbundle --release --no-tree-shake-icons

      - name: Upload AAB artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-release-aab
          path: mobile/build/app/outputs/bundle/release/*.aab

      - name: Upload APK artifact (fallback)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: oblns
          path: mobile/build/app/outputs/flutter-apk/*.apk
